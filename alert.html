<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stream Alert</title>
  <link rel="stylesheet" href="alert.css" />
</head>

<body>
  <!-- Ambient animation (5s) -->
  <video
    id="background"
    src="ambient_pulse.webm"
    autoplay
    muted
    playsinline
  ></video>

  <div id="alert">
    <div id="alertType"></div>
    <div id="username"></div>
    <div id="platformLine"></div>
    <div id="subtext"></div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.hash.substring(1));

    function getParam(name) {
      const v = params.get(name);
      if (!v) return "";
      try {
        return decodeURIComponent(v.replace(/\+/g, " ")).trim();
      } catch {
        return v.replace(/\+/g, " ").trim();
      }
    }

    // Common
    const alertTypeRaw = getParam("alertType");  // e.g. TwitchFollow OR TTFollow
    const platform     = getParam("platform");  // twitch / tiktok
    const userName     = getParam("userName");  // twitch: userName, tiktok: username OR nickname
    const nickname     = getParam("nickname");  // tiktok: nicer display name

    // Twitch optional
    const bits      = getParam("bits");
    const gifts     = getParam("gifts");
    const tier      = getParam("tier");
    const recipient = getParam("recipient");
    const reward    = getParam("reward");
    const cost      = getParam("cost");
    const anonymous = getParam("anonymous");

    // TikTok optional
    const giftName    = getParam("giftName");
    const coins       = getParam("coins");       // often per gift
    const repeatCount = getParam("repeatCount"); // streak/quantity
    const subMonth    = getParam("subMonth");

    // Prefer TikTok nickname if present
    const displayUser = (nickname || userName || "").trim();

    // Map event -> title (Twitch + TikTok)
    const titleMap = {
      // Twitch
      TwitchFollow: "A NEW SOUL ARRIVES",
      TwitchSub: "A BOND IS FORMED",
      TwitchCheer: "ENERGY WAS SHARED",
      TwitchGiftSub: "A BLESSING WAS GIVEN",
      TwitchGiftBomb: "BLESSINGS WERE SHARED",
      TwitchRewardRedemption: "FATE WAS ALTERED",

      // TikTok
      TTFollow: "A NEW SOUL ARRIVES",
      TTGift: "AN OFFERING WAS MADE",
      TTSub: "A BOND IS FORMED"
    };

    //Map platform --> platformLine
    const platformMap = {
      twitch: "FROM TWITCH",
      tiktok: "FROM TIKTOK",
      youtube: "FROM YOUTUBE"
    };

    function prettifyFallback(s) {
      return (s || "ALERT")
        .replace(/([a-z])([A-Z])/g, "$1 $2")
        .replace(/[_-]+/g, " ")
        .trim()
        .toUpperCase();
    }

    const title = titleMap[alertTypeRaw] || prettifyFallback(alertTypeRaw);

    // Build optional subtext
    let subtext = "";

    // Twitch: bits
    if (alertTypeRaw === "TwitchCheer" && bits) {
      subtext = `${bits} ENERGY OFFERED`;
    }

    // Twitch: gift bomb
    if (alertTypeRaw === "TwitchGiftBomb") {
      const anonTag = (anonymous && anonymous.toLowerCase() === "true") ? " (ANON)" : "";
      if (gifts) subtext = `${gifts} GIFTS${anonTag}`;
      else if (anonTag) subtext = `GIFT BOMB${anonTag}`;
      if (tier) subtext += subtext ? ` • ${tier.toUpperCase()}` : tier.toUpperCase();
    }

    // Twitch: gifted sub
    if (alertTypeRaw === "TwitchGiftSub") {
      if (recipient) subtext = `TO ${recipient.toUpperCase()}`;
      if (tier) subtext += subtext ? ` • ${tier.toUpperCase()}` : tier.toUpperCase();
    }

    // Twitch: sub tier
    if (alertTypeRaw === "TwitchSub" && tier) {
      subtext = `${tier.toUpperCase()} • A BOND IS FORMED`;
    }

    // Twitch: channel points
    if (alertTypeRaw === "TwitchRewardRedemption") {
      if (reward && cost) subtext = `${reward} • ${cost} CP`;
      else if (reward) subtext = reward;
      else if (cost) subtext = `${cost} CP`;
    }

    // TikTok: gifts
    // Show: "ROSE ×3 • 3 COINS" (total coins if possible)
    if (alertTypeRaw === "TTGift") {
      const name = giftName ? giftName.toUpperCase() : "";
      const qty = parseInt(repeatCount, 10);
      const c = parseInt(coins, 10);

      const qtyText = Number.isFinite(qty) && qty > 1 ? ` ×${qty}` : "";
      let energyText = "";

      if (Number.isFinite(c)) {
        const total = (Number.isFinite(qty) && qty > 1) ? (c * qty) : c;
        energyText = `${total} ENERGY`;
      }

      if (name && energyText) subtext = `${name}${qtyText} • ${energyText} OFFERED`;
      else if (name) subtext = `${name}${qtyText}`;
      else if (energyText) subtext = `${energyText} OFFERED`;
    }

    // TikTok: subs
    if (alertTypeRaw === "TTSub" && subMonth) {
      subtext = `BOUND FOR ${subMonth} MONTH${subMonth === "1" ? "" : "S"}`;
    }
    // Apply
    document.getElementById("alertType").textContent = title;
    document.getElementById("username").textContent = displayUser;
    document.getElementById("subtext").textContent = subtext;
    const platformText =
      platformMap[platform?.toLowerCase?.()] ||
      (platform ? `ENERGY CHANNEL: ${platform.toUpperCase()}` : "");
    document.getElementById("platformLine").textContent = platformText;

    if (platform) document.body.classList.add(`platform-${platform}`);
  </script>
</body>
</html>
